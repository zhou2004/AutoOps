# Cron表达式格式修复说明

## 问题描述

之前定时同步功能的cron表达式配置存在格式不匹配问题：
- 配置中使用的是5位标准格式：`*/3 * * * *`（分时日月周）
- 调度器使用的是6位格式（包含秒位）

导致定时任务无法正常执行。

## 解决方案

### 1. 统一使用标准5位cron格式

**格式**: `分 时 日 月 周`

**示例**:
- `*/3 * * * *` - 每3分钟执行
- `0 2 * * *` - 每天凌晨2点执行
- `30 9 * * 1-5` - 工作日上午9:30执行
- `0 */6 * * *` - 每6小时执行

### 2. 修改内容

#### 调度器修改
- 移除 `cron.WithSeconds()` 选项
- 使用 `cron.New()` 创建标准5位解析器

#### Service层修改
- `validateCronExpr()` 只验证5位格式
- `calculateNextRunTime()` 使用5位解析器

### 3. 重启后生效

修改代码后需要：
1. 重新编译：`go build -o dodevops-api .`
2. 重启应用程序
3. 调度器会自动重新加载所有启用的配置

## 测试方法

### 1. 创建测试配置

```bash
curl -X POST http://10.7.16.22:8080/api/v1/config/sync-schedule \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "测试3分钟同步",
    "cronExpr": "*/3 * * * *",
    "keyTypes": "[1]",
    "status": 1,
    "remark": "每3分钟执行一次测试"
  }'
```

### 2. 查看调度器状态

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://10.7.16.22:8080/api/v1/config/sync-schedule/scheduler-stats
```

### 3. 检查日志

重启应用后查看日志中是否有：
- "启动定时同步调度器..."
- "定时同步调度器启动成功"
- "添加定时同步配置: ID=1, Name=xxx"

### 4. 等待执行

- 配置：`*/3 * * * *`
- 当前时间：18:16:53 创建
- 下次执行：18:18:00（下一个3分钟整点）
- 再下次：18:21:00

## 常用cron表达式

| 表达式 | 说明 |
|--------|------|
| `*/5 * * * *` | 每5分钟 |
| `0 * * * *` | 每小时整点 |
| `0 */2 * * *` | 每2小时 |
| `0 9 * * *` | 每天上午9点 |
| `30 14 * * *` | 每天下午2:30 |
| `0 9 * * 1-5` | 工作日上午9点 |
| `0 2 1 * *` | 每月1号凌晨2点 |

## 注意事项

1. **重启必需**：修改cron格式后必须重启应用程序
2. **配置重载**：重启后调度器会自动加载所有status=1的配置
3. **日志监控**：可通过日志确认定时任务是否正常执行
4. **格式验证**：创建/更新配置时会验证cron表达式格式