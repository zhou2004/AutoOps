# è¿ç»´å·¥å…·ç®± - å‰ç«¯å¯¹æ¥å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•
- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [API æ¥å£åˆ—è¡¨](#api-æ¥å£åˆ—è¡¨)
- [å‰ç«¯é¡µé¢è®¾è®¡å»ºè®®](#å‰ç«¯é¡µé¢è®¾è®¡å»ºè®®)
- [å®Œæ•´è°ƒç”¨æµç¨‹](#å®Œæ•´è°ƒç”¨æµç¨‹)
- [Vue3 ç¤ºä¾‹ä»£ç ](#vue3-ç¤ºä¾‹ä»£ç )
- [React ç¤ºä¾‹ä»£ç ](#react-ç¤ºä¾‹ä»£ç )
- [å¸¸è§é—®é¢˜å¤„ç†](#å¸¸è§é—®é¢˜å¤„ç†)

---

## åŠŸèƒ½æ¦‚è¿°

å®ç°åœ¨ Docker ç¯å¢ƒä¸‹çš„ä¸€é”®éƒ¨ç½²å®‰è£…ï¼Œæ”¯æŒ 16 ä¸ªå¸¸ç”¨æœåŠ¡ï¼š
- **æ•°æ®åº“**ï¼šMySQLã€Redisã€PostgreSQL
- **CI/CD**ï¼šJenkinsã€GitLab
- **ç›‘æ§æ—¥å¿—**ï¼šGrafanaã€Elasticsearchã€Lokiã€Prometheusã€ELKã€N9Eã€Filebeat
- **å®‰å…¨è¿ç»´**ï¼šJumpServer
- **å¼€å‘ç¯å¢ƒ**ï¼šNode.jsã€Javaã€Golang

---

## API æ¥å£åˆ—è¡¨

### åŸºç¡€ URL
```
http://your-domain:8080/api/v1
```

### æ¥å£æ¸…å•

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|---------|------|------|
| `/tool/services` | GET | è·å–å¯éƒ¨ç½²æœåŠ¡åˆ—è¡¨ |
| `/tool/services/:serviceId` | GET | è·å–æœåŠ¡è¯¦æƒ… |
| `/tool/deploy` | POST | åˆ›å»ºéƒ¨ç½²ä»»åŠ¡ |
| `/tool/deploy/list` | GET | è·å–éƒ¨ç½²å†å²åˆ—è¡¨ |
| `/tool/deploy/:id/status` | GET | è·å–éƒ¨ç½²çŠ¶æ€ |
| `/tool/deploy/:id` | DELETE | å¸è½½æœåŠ¡ |

---

## å‰ç«¯é¡µé¢è®¾è®¡å»ºè®®

### é¡µé¢ç»“æ„

```
è¿ç»´å·¥å…·ç®±
â”œâ”€â”€ æœåŠ¡å¸‚åœºé¡µé¢ï¼ˆæœåŠ¡åˆ—è¡¨ï¼‰
â”‚   â”œâ”€â”€ åˆ†ç±»ç­›é€‰ï¼ˆæ•°æ®åº“ã€CI/CDã€ç›‘æ§ç­‰ï¼‰
â”‚   â”œâ”€â”€ æœåŠ¡å¡ç‰‡ï¼ˆå›¾æ ‡ã€åç§°ã€æè¿°ï¼‰
â”‚   â””â”€â”€ ç‚¹å‡»å¡ç‰‡è¿›å…¥éƒ¨ç½²é¡µé¢
â”‚
â”œâ”€â”€ æœåŠ¡éƒ¨ç½²é¡µé¢
â”‚   â”œâ”€â”€ æœåŠ¡ä¿¡æ¯å±•ç¤º
â”‚   â”œâ”€â”€ ç‰ˆæœ¬é€‰æ‹©
â”‚   â”œâ”€â”€ ä¸»æœºé€‰æ‹©ï¼ˆä» CMDBï¼‰
â”‚   â”œâ”€â”€ å®‰è£…é…ç½®ï¼ˆç›®å½•ã€ç«¯å£ã€ç¯å¢ƒå˜é‡ï¼‰
â”‚   â””â”€â”€ éƒ¨ç½²æŒ‰é’®
â”‚
â””â”€â”€ éƒ¨ç½²ç®¡ç†é¡µé¢
    â”œâ”€â”€ éƒ¨ç½²å†å²åˆ—è¡¨
    â”œâ”€â”€ çŠ¶æ€ç­›é€‰
    â”œâ”€â”€ å®æ—¶æ—¥å¿—æŸ¥çœ‹
    â””â”€â”€ æ“ä½œæŒ‰é’®ï¼ˆæŸ¥çœ‹æ—¥å¿—ã€å¸è½½ï¼‰
```

---

## å®Œæ•´è°ƒç”¨æµç¨‹

### æµç¨‹å›¾

```
1. ç”¨æˆ·è®¿é—®æœåŠ¡å¸‚åœº
   â†“
2. è°ƒç”¨ GET /tool/services è·å–æœåŠ¡åˆ—è¡¨
   â†“
3. ç”¨æˆ·é€‰æ‹©æœåŠ¡ï¼ˆå¦‚ MySQLï¼‰
   â†“
4. è°ƒç”¨ GET /tool/services/mysql è·å–è¯¦æƒ…
   â†“
5. å±•ç¤ºç‰ˆæœ¬é€‰æ‹©ã€é…ç½®è¡¨å•
   â†“
6. ç”¨æˆ·å¡«å†™é…ç½®ï¼Œç‚¹å‡»éƒ¨ç½²
   â†“
7. è°ƒç”¨ POST /tool/deploy åˆ›å»ºéƒ¨ç½²ä»»åŠ¡
   â†“
8. åå°è¿”å› deployId
   â†“
9. å¼€å¯è½®è¯¢ï¼šæ¯ 3 ç§’è°ƒç”¨ GET /tool/deploy/:id/status
   â†“
10. å®æ—¶å±•ç¤ºéƒ¨ç½²è¿›åº¦å’Œæ—¥å¿—
   â†“
11. éƒ¨ç½²å®Œæˆï¼ˆstatus=1ï¼‰æˆ–å¤±è´¥ï¼ˆstatus=3ï¼‰
   â†“
12. åœæ­¢è½®è¯¢ï¼Œå±•ç¤ºæœ€ç»ˆç»“æœ
```

---

## Vue3 ç¤ºä¾‹ä»£ç 

### 1. API è¯·æ±‚å°è£…ï¼ˆapi/tool.jsï¼‰

```javascript
import request from '@/utils/request'

// è·å–æœåŠ¡åˆ—è¡¨
export function getServicesList() {
  return request({
    url: '/api/v1/tool/services',
    method: 'get'
  })
}

// è·å–æœåŠ¡è¯¦æƒ…
export function getServiceDetail(serviceId) {
  return request({
    url: `/api/v1/tool/services/${serviceId}`,
    method: 'get'
  })
}

// åˆ›å»ºéƒ¨ç½²ä»»åŠ¡
export function createDeploy(data) {
  return request({
    url: '/api/v1/tool/deploy',
    method: 'post',
    data
  })
}

// è·å–éƒ¨ç½²å†å²åˆ—è¡¨
export function getDeployList(params) {
  return request({
    url: '/api/v1/tool/deploy/list',
    method: 'get',
    params
  })
}

// è·å–éƒ¨ç½²çŠ¶æ€
export function getDeployStatus(id) {
  return request({
    url: `/api/v1/tool/deploy/${id}/status`,
    method: 'get'
  })
}

// å¸è½½æœåŠ¡
export function deleteDeploy(id) {
  return request({
    url: `/api/v1/tool/deploy/${id}`,
    method: 'delete'
  })
}
```

### 2. æœåŠ¡å¸‚åœºé¡µé¢ï¼ˆServiceMarket.vueï¼‰

```vue
<template>
  <div class="service-market">
    <!-- åˆ†ç±»ç­›é€‰ -->
    <div class="category-filter">
      <el-radio-group v-model="selectedCategory" @change="handleCategoryChange">
        <el-radio-button label="">å…¨éƒ¨</el-radio-button>
        <el-radio-button
          v-for="cat in categories"
          :key="cat.id"
          :label="cat.id"
        >
          {{ cat.name }}
        </el-radio-button>
      </el-radio-group>
    </div>

    <!-- æœåŠ¡åˆ—è¡¨ -->
    <div class="service-grid">
      <el-card
        v-for="service in filteredServices"
        :key="service.id"
        class="service-card"
        shadow="hover"
        @click="openDeployDialog(service)"
      >
        <div class="service-icon">
          <el-icon :size="48">
            <component :is="getIcon(service.icon)" />
          </el-icon>
        </div>
        <h3>{{ service.name }}</h3>
        <p class="description">{{ service.description }}</p>
        <div class="versions">
          <el-tag
            v-for="version in service.versions.slice(0, 3)"
            :key="version.id"
            :type="version.recommended ? 'success' : ''"
            size="small"
          >
            {{ version.name }}
          </el-tag>
        </div>
      </el-card>
    </div>

    <!-- éƒ¨ç½²å¯¹è¯æ¡† -->
    <DeployDialog
      v-model="deployDialogVisible"
      :service="selectedService"
      @deployed="handleDeployed"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { getServicesList } from '@/api/tool'
import { ElMessage } from 'element-plus'
import { Database, Operation, Monitor, Lock, Code } from '@element-plus/icons-vue'
import DeployDialog from './DeployDialog.vue'

const services = ref([])
const categories = ref([])
const selectedCategory = ref('')
const deployDialogVisible = ref(false)
const selectedService = ref(null)

// å›¾æ ‡æ˜ å°„
const iconMap = {
  'database': Database,
  'tool': Operation,
  'chart': Monitor,
  'shield': Lock,
  'code': Code
}

const getIcon = (iconName) => iconMap[iconName] || Database

// è¿‡æ»¤æœåŠ¡
const filteredServices = computed(() => {
  if (!selectedCategory.value) return services.value
  return services.value.filter(s => s.category === selectedCategory.value)
})

// åŠ è½½æœåŠ¡åˆ—è¡¨
const loadServices = async () => {
  try {
    const res = await getServicesList()
    if (res.code === 200) {
      services.value = res.data.services
      categories.value = res.data.categories
    }
  } catch (error) {
    ElMessage.error('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥')
  }
}

// æ‰“å¼€éƒ¨ç½²å¯¹è¯æ¡†
const openDeployDialog = (service) => {
  selectedService.value = service
  deployDialogVisible.value = true
}

// éƒ¨ç½²å®Œæˆå›è°ƒ
const handleDeployed = (deployId) => {
  ElMessage.success('éƒ¨ç½²ä»»åŠ¡å·²åˆ›å»º')
  // å¯ä»¥è·³è½¬åˆ°éƒ¨ç½²ç®¡ç†é¡µé¢æŸ¥çœ‹è¿›åº¦
  // router.push({ name: 'DeployManage', params: { id: deployId } })
}

const handleCategoryChange = () => {
  // åˆ†ç±»å˜åŒ–å¤„ç†
}

onMounted(() => {
  loadServices()
})
</script>

<style scoped>
.service-market {
  padding: 20px;
}

.category-filter {
  margin-bottom: 20px;
}

.service-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

.service-card {
  cursor: pointer;
  transition: transform 0.2s;
  text-align: center;
}

.service-card:hover {
  transform: translateY(-5px);
}

.service-icon {
  margin-bottom: 15px;
  color: #409eff;
}

.description {
  color: #999;
  font-size: 14px;
  margin: 10px 0;
}

.versions {
  display: flex;
  gap: 5px;
  justify-content: center;
  flex-wrap: wrap;
}
</style>
```

### 3. éƒ¨ç½²å¯¹è¯æ¡†ç»„ä»¶ï¼ˆDeployDialog.vueï¼‰

```vue
<template>
  <el-dialog
    v-model="visible"
    :title="`éƒ¨ç½² ${service?.name}`"
    width="700px"
    @close="handleClose"
  >
    <el-form
      ref="formRef"
      :model="formData"
      :rules="rules"
      label-width="120px"
    >
      <!-- ç‰ˆæœ¬é€‰æ‹© -->
      <el-form-item label="é€‰æ‹©ç‰ˆæœ¬" prop="version">
        <el-select v-model="formData.version" placeholder="è¯·é€‰æ‹©ç‰ˆæœ¬">
          <el-option
            v-for="ver in service?.versions"
            :key="ver.id"
            :label="ver.name"
            :value="ver.id"
          >
            <span>{{ ver.name }}</span>
            <el-tag
              v-if="ver.recommended"
              type="success"
              size="small"
              style="margin-left: 10px"
            >
              æ¨è
            </el-tag>
          </el-option>
        </el-select>
      </el-form-item>

      <!-- ä¸»æœºé€‰æ‹© -->
      <el-form-item label="ç›®æ ‡ä¸»æœº" prop="hostId">
        <el-select
          v-model="formData.hostId"
          placeholder="è¯·é€‰æ‹©ä¸»æœº"
          filterable
        >
          <el-option
            v-for="host in hosts"
            :key="host.id"
            :label="`${host.hostName} (${host.sshIp})`"
            :value="host.id"
            :disabled="host.status !== 1"
          >
            <span>{{ host.hostName }}</span>
            <span style="float: right; color: #8492a6; font-size: 13px">
              {{ host.sshIp }}
            </span>
          </el-option>
        </el-select>
      </el-form-item>

      <!-- å®‰è£…ç›®å½• -->
      <el-form-item label="å®‰è£…ç›®å½•" prop="installDir">
        <el-input
          v-model="formData.installDir"
          placeholder="/opt/data/mysql"
        >
          <template #prepend>ç›®å½•</template>
        </el-input>
      </el-form-item>

      <!-- ç¯å¢ƒå˜é‡ -->
      <el-form-item
        v-for="envVar in service?.env_vars"
        :key="envVar.name"
        :label="envVar.description"
        :prop="`envVars.${envVar.name}`"
        :rules="envVar.required ? [{ required: true, message: 'ä¸èƒ½ä¸ºç©º' }] : []"
      >
        <el-input
          v-model="formData.envVars[envVar.name]"
          :placeholder="envVar.default"
          :type="envVar.name.includes('PASSWORD') ? 'password' : 'text'"
          show-password
        />
        <div class="env-tip">é»˜è®¤å€¼: {{ envVar.default || 'æ— ' }}</div>
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="visible = false">å–æ¶ˆ</el-button>
      <el-button
        type="primary"
        @click="handleDeploy"
        :loading="deploying"
      >
        {{ deploying ? 'éƒ¨ç½²ä¸­...' : 'å¼€å§‹éƒ¨ç½²' }}
      </el-button>
    </template>

    <!-- éƒ¨ç½²è¿›åº¦å¯¹è¯æ¡† -->
    <DeployProgress
      v-model="progressVisible"
      :deploy-id="deployId"
      @close="handleProgressClose"
    />
  </el-dialog>
</template>

<script setup>
import { ref, reactive, watch, computed } from 'vue'
import { createDeploy } from '@/api/tool'
import { getHostList } from '@/api/cmdb'
import { ElMessage } from 'element-plus'
import DeployProgress from './DeployProgress.vue'

const props = defineProps({
  modelValue: Boolean,
  service: Object
})

const emit = defineEmits(['update:modelValue', 'deployed'])

const visible = computed({
  get: () => props.modelValue,
  set: (val) => emit('update:modelValue', val)
})

const formRef = ref()
const deploying = ref(false)
const progressVisible = ref(false)
const deployId = ref(null)
const hosts = ref([])

const formData = reactive({
  version: '',
  hostId: null,
  installDir: '',
  envVars: {}
})

const rules = {
  version: [{ required: true, message: 'è¯·é€‰æ‹©ç‰ˆæœ¬', trigger: 'change' }],
  hostId: [{ required: true, message: 'è¯·é€‰æ‹©ä¸»æœº', trigger: 'change' }],
  installDir: [{ required: true, message: 'è¯·è¾“å…¥å®‰è£…ç›®å½•', trigger: 'blur' }]
}

// åŠ è½½ä¸»æœºåˆ—è¡¨
const loadHosts = async () => {
  try {
    const res = await getHostList({ pageNum: 1, pageSize: 1000 })
    if (res.code === 200) {
      hosts.value = res.data.list
    }
  } catch (error) {
    ElMessage.error('åŠ è½½ä¸»æœºåˆ—è¡¨å¤±è´¥')
  }
}

// ç›‘å¬æœåŠ¡å˜åŒ–ï¼Œåˆå§‹åŒ–è¡¨å•
watch(() => props.service, (newVal) => {
  if (newVal) {
    // è®¾ç½®é»˜è®¤ç‰ˆæœ¬ï¼ˆæ¨èç‰ˆæœ¬ï¼‰
    const recommended = newVal.versions.find(v => v.recommended)
    formData.version = recommended?.id || newVal.versions[0]?.id

    // è®¾ç½®é»˜è®¤å®‰è£…ç›®å½•
    formData.installDir = `/opt/data/${newVal.id}`

    // åˆå§‹åŒ–ç¯å¢ƒå˜é‡
    formData.envVars = {}
    newVal.env_vars?.forEach(env => {
      formData.envVars[env.name] = env.default
    })
  }
}, { immediate: true })

// å¼€å§‹éƒ¨ç½²
const handleDeploy = async () => {
  try {
    await formRef.value.validate()

    deploying.value = true
    const res = await createDeploy({
      serviceId: props.service.id,
      version: formData.version,
      hostId: formData.hostId,
      installDir: formData.installDir,
      envVars: formData.envVars,
      autoStart: true
    })

    deploying.value = false

    if (res.code === 200) {
      ElMessage.success('éƒ¨ç½²ä»»åŠ¡å·²åˆ›å»º')
      deployId.value = res.data.deployId
      progressVisible.value = true
      visible.value = false
      emit('deployed', res.data.deployId)
    } else {
      ElMessage.error(res.message || 'éƒ¨ç½²å¤±è´¥')
    }
  } catch (error) {
    deploying.value = false
    console.error('éƒ¨ç½²å¤±è´¥', error)
  }
}

const handleClose = () => {
  formRef.value?.resetFields()
}

const handleProgressClose = () => {
  progressVisible.value = false
}

// åˆå§‹åŒ–åŠ è½½ä¸»æœºåˆ—è¡¨
loadHosts()
</script>

<style scoped>
.env-tip {
  font-size: 12px;
  color: #999;
  margin-top: 5px;
}
</style>
```

### 4. éƒ¨ç½²è¿›åº¦ç»„ä»¶ï¼ˆDeployProgress.vueï¼‰

```vue
<template>
  <el-dialog
    v-model="visible"
    title="éƒ¨ç½²è¿›åº¦"
    width="800px"
    :close-on-click-modal="false"
    @close="handleClose"
  >
    <!-- çŠ¶æ€å¡ç‰‡ -->
    <el-card class="status-card">
      <div class="status-info">
        <div class="status-icon">
          <el-icon :size="60" :color="statusColor">
            <Loading v-if="deployInfo.status === 0" />
            <CircleCheck v-else-if="deployInfo.status === 1" />
            <CircleClose v-else-if="deployInfo.status === 3" />
            <Remove v-else />
          </el-icon>
        </div>
        <div class="status-text">
          <h3>{{ deployInfo.serviceName }} {{ deployInfo.version }}</h3>
          <el-tag :type="statusTagType" size="large">
            {{ deployInfo.statusText }}
          </el-tag>
          <p class="host-info">
            ä¸»æœº: {{ deployInfo.hostName }} ({{ deployInfo.hostIp }})
          </p>
          <p class="install-dir">
            å®‰è£…ç›®å½•: {{ deployInfo.installDir }}
          </p>
        </div>
      </div>
    </el-card>

    <!-- éƒ¨ç½²æ—¥å¿— -->
    <div class="deploy-log">
      <div class="log-header">
        <h4>éƒ¨ç½²æ—¥å¿—</h4>
        <el-button
          size="small"
          @click="copyLog"
        >
          å¤åˆ¶æ—¥å¿—
        </el-button>
      </div>
      <div class="log-content" ref="logRef">
        <pre>{{ deployInfo.deployLog || 'æ­£åœ¨è·å–æ—¥å¿—...' }}</pre>
      </div>
    </div>

    <template #footer>
      <el-button
        v-if="deployInfo.status === 0"
        type="info"
        disabled
      >
        éƒ¨ç½²ä¸­ï¼Œè¯·ç¨å€™...
      </el-button>
      <el-button
        v-else
        type="primary"
        @click="visible = false"
      >
        å…³é—­
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, computed, watch, onUnmounted, nextTick } from 'vue'
import { getDeployStatus } from '@/api/tool'
import { ElMessage } from 'element-plus'
import {
  Loading,
  CircleCheck,
  CircleClose,
  Remove
} from '@element-plus/icons-vue'

const props = defineProps({
  modelValue: Boolean,
  deployId: [Number, String]
})

const emit = defineEmits(['update:modelValue', 'close'])

const visible = computed({
  get: () => props.modelValue,
  set: (val) => emit('update:modelValue', val)
})

const deployInfo = ref({
  status: 0,
  statusText: 'éƒ¨ç½²ä¸­',
  serviceName: '',
  version: '',
  hostName: '',
  hostIp: '',
  installDir: '',
  deployLog: ''
})

const logRef = ref()
let pollingTimer = null

// çŠ¶æ€é¢œè‰²
const statusColor = computed(() => {
  const colors = {
    0: '#409eff', // éƒ¨ç½²ä¸­
    1: '#67c23a', // è¿è¡Œä¸­
    2: '#909399', // å·²åœæ­¢
    3: '#f56c6c'  // éƒ¨ç½²å¤±è´¥
  }
  return colors[deployInfo.value.status] || '#909399'
})

// çŠ¶æ€æ ‡ç­¾ç±»å‹
const statusTagType = computed(() => {
  const types = {
    0: 'primary',
    1: 'success',
    2: 'info',
    3: 'danger'
  }
  return types[deployInfo.value.status] || 'info'
})

// è·å–éƒ¨ç½²çŠ¶æ€
const fetchDeployStatus = async () => {
  if (!props.deployId) return

  try {
    const res = await getDeployStatus(props.deployId)
    if (res.code === 200) {
      deployInfo.value = res.data

      // è‡ªåŠ¨æ»šåŠ¨åˆ°æ—¥å¿—åº•éƒ¨
      nextTick(() => {
        if (logRef.value) {
          logRef.value.scrollTop = logRef.value.scrollHeight
        }
      })

      // å¦‚æœéƒ¨ç½²å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
      if (res.data.status === 1 || res.data.status === 3) {
        stopPolling()

        if (res.data.status === 1) {
          ElMessage.success('éƒ¨ç½²æˆåŠŸï¼')
        } else {
          ElMessage.error('éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—')
        }
      }
    }
  } catch (error) {
    console.error('è·å–éƒ¨ç½²çŠ¶æ€å¤±è´¥', error)
  }
}

// å¼€å§‹è½®è¯¢
const startPolling = () => {
  fetchDeployStatus() // ç«‹å³è·å–ä¸€æ¬¡
  pollingTimer = setInterval(fetchDeployStatus, 3000) // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
}

// åœæ­¢è½®è¯¢
const stopPolling = () => {
  if (pollingTimer) {
    clearInterval(pollingTimer)
    pollingTimer = null
  }
}

// å¤åˆ¶æ—¥å¿—
const copyLog = () => {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(deployInfo.value.deployLog)
    ElMessage.success('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  }
}

const handleClose = () => {
  stopPolling()
  emit('close')
}

// ç›‘å¬ deployId å˜åŒ–
watch(() => props.deployId, (newVal) => {
  if (newVal && props.modelValue) {
    startPolling()
  }
}, { immediate: true })

// ç›‘å¬å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
watch(() => props.modelValue, (newVal) => {
  if (newVal && props.deployId) {
    startPolling()
  } else {
    stopPolling()
  }
})

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†
onUnmounted(() => {
  stopPolling()
})
</script>

<style scoped>
.status-card {
  margin-bottom: 20px;
}

.status-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.status-text h3 {
  margin: 0 0 10px 0;
}

.host-info, .install-dir {
  margin: 5px 0;
  color: #666;
  font-size: 14px;
}

.deploy-log {
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  overflow: hidden;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: #f5f7fa;
  border-bottom: 1px solid #dcdfe6;
}

.log-header h4 {
  margin: 0;
}

.log-content {
  height: 400px;
  overflow-y: auto;
  padding: 15px;
  background: #1e1e1e;
  color: #d4d4d4;
  font-family: 'Courier New', monospace;
  font-size: 13px;
}

.log-content pre {
  margin: 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}
</style>
```

### 5. éƒ¨ç½²ç®¡ç†é¡µé¢ï¼ˆDeployManage.vueï¼‰

```vue
<template>
  <div class="deploy-manage">
    <el-card>
      <!-- æœç´¢æ  -->
      <el-form :inline="true" :model="queryParams">
        <el-form-item label="æœåŠ¡åç§°">
          <el-input
            v-model="queryParams.serviceName"
            placeholder="è¯·è¾“å…¥æœåŠ¡åç§°"
            clearable
          />
        </el-form-item>
        <el-form-item label="çŠ¶æ€">
          <el-select v-model="queryParams.status" clearable>
            <el-option label="å…¨éƒ¨" :value="-1" />
            <el-option label="éƒ¨ç½²ä¸­" :value="0" />
            <el-option label="è¿è¡Œä¸­" :value="1" />
            <el-option label="å·²åœæ­¢" :value="2" />
            <el-option label="éƒ¨ç½²å¤±è´¥" :value="3" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleQuery">æŸ¥è¯¢</el-button>
          <el-button @click="handleReset">é‡ç½®</el-button>
        </el-form-item>
      </el-form>

      <!-- è¡¨æ ¼ -->
      <el-table :data="tableData" v-loading="loading">
        <el-table-column prop="serviceName" label="æœåŠ¡åç§°" width="150" />
        <el-table-column prop="version" label="ç‰ˆæœ¬" width="150" />
        <el-table-column label="ä¸»æœº" width="200">
          <template #default="{ row }">
            <div>{{ row.hostName }}</div>
            <div style="color: #999; font-size: 12px">{{ row.hostIp }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="installDir" label="å®‰è£…ç›®å½•" width="200" />
        <el-table-column label="çŠ¶æ€" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">
              {{ row.statusText }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="éƒ¨ç½²æ—¶é—´" width="180" />
        <el-table-column label="æ“ä½œ" fixed="right" width="200">
          <template #default="{ row }">
            <el-button
              type="primary"
              link
              @click="viewLog(row)"
            >
              æŸ¥çœ‹æ—¥å¿—
            </el-button>
            <el-popconfirm
              title="ç¡®å®šè¦å¸è½½æ­¤æœåŠ¡å—ï¼Ÿ"
              @confirm="handleUninstall(row.id)"
            >
              <template #reference>
                <el-button type="danger" link>
                  å¸è½½
                </el-button>
              </template>
            </el-popconfirm>
          </template>
        </el-table-column>
      </el-table>

      <!-- åˆ†é¡µ -->
      <el-pagination
        v-model:current-page="queryParams.pageNum"
        v-model:page-size="queryParams.pageSize"
        :total="total"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleQuery"
        @current-change="handleQuery"
      />
    </el-card>

    <!-- æ—¥å¿—æŸ¥çœ‹å¯¹è¯æ¡† -->
    <DeployProgress
      v-model="logVisible"
      :deploy-id="currentDeployId"
    />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { getDeployList, deleteDeploy } from '@/api/tool'
import { ElMessage } from 'element-plus'
import DeployProgress from './DeployProgress.vue'

const loading = ref(false)
const tableData = ref([])
const total = ref(0)
const logVisible = ref(false)
const currentDeployId = ref(null)

const queryParams = reactive({
  serviceName: '',
  status: -1,
  pageNum: 1,
  pageSize: 10
})

// çŠ¶æ€ç±»å‹æ˜ å°„
const getStatusType = (status) => {
  const types = {
    0: 'primary',
    1: 'success',
    2: 'info',
    3: 'danger'
  }
  return types[status] || 'info'
}

// æŸ¥è¯¢åˆ—è¡¨
const handleQuery = async () => {
  loading.value = true
  try {
    const res = await getDeployList(queryParams)
    if (res.code === 200) {
      tableData.value = res.data.list
      total.value = res.data.total
    }
  } catch (error) {
    ElMessage.error('æŸ¥è¯¢å¤±è´¥')
  } finally {
    loading.value = false
  }
}

// é‡ç½®æŸ¥è¯¢
const handleReset = () => {
  queryParams.serviceName = ''
  queryParams.status = -1
  queryParams.pageNum = 1
  handleQuery()
}

// æŸ¥çœ‹æ—¥å¿—
const viewLog = (row) => {
  currentDeployId.value = row.id
  logVisible.value = true
}

// å¸è½½æœåŠ¡
const handleUninstall = async (id) => {
  try {
    const res = await deleteDeploy(id)
    if (res.code === 200) {
      ElMessage.success('å¸è½½æˆåŠŸ')
      handleQuery()
    } else {
      ElMessage.error(res.message || 'å¸è½½å¤±è´¥')
    }
  } catch (error) {
    ElMessage.error('å¸è½½å¤±è´¥')
  }
}

onMounted(() => {
  handleQuery()
})
</script>

<style scoped>
.deploy-manage {
  padding: 20px;
}

.el-pagination {
  margin-top: 20px;
  text-align: right;
}
</style>
```

---

## React ç¤ºä¾‹ä»£ç 

### 1. API è¯·æ±‚å°è£…ï¼ˆapi/tool.tsï¼‰

```typescript
import request from '@/utils/request'

export interface ServiceInfo {
  id: string
  name: string
  category: string
  description: string
  icon: string
  versions: ServiceVersion[]
  default_port: number
  env_vars: ServiceEnvVar[]
}

export interface ServiceVersion {
  id: string
  name: string
  file: string
  stable: boolean
  recommended: boolean
}

export interface ServiceEnvVar {
  name: string
  description: string
  required: boolean
  default: string
}

export interface DeployParams {
  serviceId: string
  version: string
  hostId: number
  installDir: string
  envVars: Record<string, any>
  autoStart?: boolean
}

// è·å–æœåŠ¡åˆ—è¡¨
export const getServicesList = () => {
  return request.get('/api/v1/tool/services')
}

// è·å–æœåŠ¡è¯¦æƒ…
export const getServiceDetail = (serviceId: string) => {
  return request.get(`/api/v1/tool/services/${serviceId}`)
}

// åˆ›å»ºéƒ¨ç½²ä»»åŠ¡
export const createDeploy = (data: DeployParams) => {
  return request.post('/api/v1/tool/deploy', data)
}

// è·å–éƒ¨ç½²å†å²åˆ—è¡¨
export const getDeployList = (params: any) => {
  return request.get('/api/v1/tool/deploy/list', { params })
}

// è·å–éƒ¨ç½²çŠ¶æ€
export const getDeployStatus = (id: number) => {
  return request.get(`/api/v1/tool/deploy/${id}/status`)
}

// å¸è½½æœåŠ¡
export const deleteDeploy = (id: number) => {
  return request.delete(`/api/v1/tool/deploy/${id}`)
}
```

### 2. æœåŠ¡å¸‚åœºç»„ä»¶ï¼ˆServiceMarket.tsxï¼‰

```typescript
import React, { useState, useEffect } from 'react'
import { Card, Radio, Tag, message } from 'antd'
import { DatabaseOutlined, ToolOutlined, LineChartOutlined } from '@ant-design/icons'
import { getServicesList, ServiceInfo } from '@/api/tool'
import DeployModal from './DeployModal'
import './ServiceMarket.less'

const ServiceMarket: React.FC = () => {
  const [services, setServices] = useState<ServiceInfo[]>([])
  const [categories, setCategories] = useState<any[]>([])
  const [selectedCategory, setSelectedCategory] = useState('')
  const [selectedService, setSelectedService] = useState<ServiceInfo | null>(null)
  const [deployVisible, setDeployVisible] = useState(false)

  // å›¾æ ‡æ˜ å°„
  const iconMap: Record<string, any> = {
    database: <DatabaseOutlined style={{ fontSize: 48 }} />,
    tool: <ToolOutlined style={{ fontSize: 48 }} />,
    chart: <LineChartOutlined style={{ fontSize: 48 }} />
  }

  // åŠ è½½æœåŠ¡åˆ—è¡¨
  useEffect(() => {
    loadServices()
  }, [])

  const loadServices = async () => {
    try {
      const res = await getServicesList()
      if (res.code === 200) {
        setServices(res.data.services)
        setCategories(res.data.categories)
      }
    } catch (error) {
      message.error('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥')
    }
  }

  // è¿‡æ»¤æœåŠ¡
  const filteredServices = selectedCategory
    ? services.filter(s => s.category === selectedCategory)
    : services

  // æ‰“å¼€éƒ¨ç½²å¯¹è¯æ¡†
  const openDeployModal = (service: ServiceInfo) => {
    setSelectedService(service)
    setDeployVisible(true)
  }

  return (
    <div className="service-market">
      {/* åˆ†ç±»ç­›é€‰ */}
      <div className="category-filter">
        <Radio.Group
          value={selectedCategory}
          onChange={(e) => setSelectedCategory(e.target.value)}
          buttonStyle="solid"
        >
          <Radio.Button value="">å…¨éƒ¨</Radio.Button>
          {categories.map(cat => (
            <Radio.Button key={cat.id} value={cat.id}>
              {cat.name}
            </Radio.Button>
          ))}
        </Radio.Group>
      </div>

      {/* æœåŠ¡åˆ—è¡¨ */}
      <div className="service-grid">
        {filteredServices.map(service => (
          <Card
            key={service.id}
            hoverable
            className="service-card"
            onClick={() => openDeployModal(service)}
          >
            <div className="service-icon">
              {iconMap[service.icon] || iconMap.database}
            </div>
            <h3>{service.name}</h3>
            <p className="description">{service.description}</p>
            <div className="versions">
              {service.versions.slice(0, 3).map(version => (
                <Tag
                  key={version.id}
                  color={version.recommended ? 'success' : 'default'}
                >
                  {version.name}
                </Tag>
              ))}
            </div>
          </Card>
        ))}
      </div>

      {/* éƒ¨ç½²å¯¹è¯æ¡† */}
      <DeployModal
        visible={deployVisible}
        service={selectedService}
        onClose={() => setDeployVisible(false)}
        onDeployed={(deployId) => {
          message.success('éƒ¨ç½²ä»»åŠ¡å·²åˆ›å»º')
          setDeployVisible(false)
        }}
      />
    </div>
  )
}

export default ServiceMarket
```

---

## å¸¸è§é—®é¢˜å¤„ç†

### 1. è½®è¯¢ä¼˜åŒ–

```javascript
// ä½¿ç”¨ useInterval Hook ä¼˜åŒ–è½®è¯¢
import { useEffect, useRef } from 'react'

function useInterval(callback, delay) {
  const savedCallback = useRef()

  useEffect(() => {
    savedCallback.current = callback
  }, [callback])

  useEffect(() => {
    if (delay !== null) {
      const id = setInterval(() => savedCallback.current(), delay)
      return () => clearInterval(id)
    }
  }, [delay])
}

// ä½¿ç”¨ç¤ºä¾‹
const [isPolling, setIsPolling] = useState(true)

useInterval(
  () => {
    fetchDeployStatus()
  },
  isPolling ? 3000 : null // 3ç§’è½®è¯¢ï¼Œåœæ­¢æ—¶ä¼  null
)
```

### 2. é”™è¯¯å¤„ç†

```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
const handleApiError = (error, defaultMessage = 'æ“ä½œå¤±è´¥') => {
  const message = error.response?.data?.message || error.message || defaultMessage
  ElMessage.error(message)
  console.error('API Error:', error)
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  await createDeploy(deployData)
} catch (error) {
  handleApiError(error, 'éƒ¨ç½²å¤±è´¥')
}
```

### 3. ç¯å¢ƒå˜é‡å¯†ç å¤„ç†

```javascript
// æ•æ„Ÿä¿¡æ¯è„±æ•æ˜¾ç¤º
const maskPassword = (password) => {
  if (!password) return ''
  return '*'.repeat(password.length)
}

// åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
<span>{{ maskPassword(row.envVars.MYSQL_ROOT_PASSWORD) }}</span>
```

### 4. éƒ¨ç½²çŠ¶æ€è½®è¯¢ä¼˜åŒ–

```javascript
// ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
let retryCount = 0
const maxRetries = 5
const baseDelay = 3000

const fetchWithRetry = async () => {
  try {
    const res = await getDeployStatus(deployId)
    retryCount = 0 // é‡ç½®é‡è¯•æ¬¡æ•°
    return res
  } catch (error) {
    if (retryCount < maxRetries) {
      retryCount++
      const delay = baseDelay * Math.pow(2, retryCount)
      setTimeout(fetchWithRetry, delay)
    }
  }
}
```

### 5. æ—¥å¿—å®æ—¶æ»šåŠ¨

```javascript
// è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
const scrollToBottom = () => {
  nextTick(() => {
    if (logRef.value) {
      logRef.value.scrollTop = logRef.value.scrollHeight
    }
  })
}

// åœ¨æ—¥å¿—æ›´æ–°åè°ƒç”¨
watch(() => deployInfo.value.deployLog, () => {
  scrollToBottom()
})
```

---

## å®Œæ•´çš„ä½¿ç”¨æµç¨‹ç¤ºä¾‹

```javascript
// å®Œæ•´éƒ¨ç½²æµç¨‹ç¤ºä¾‹
async function deployMySQLExample() {
  // 1. è·å–æœåŠ¡åˆ—è¡¨
  const servicesRes = await getServicesList()
  const mysqlService = servicesRes.data.services.find(s => s.id === 'mysql')

  // 2. è·å–ä¸»æœºåˆ—è¡¨
  const hostsRes = await getHostList({ pageNum: 1, pageSize: 100 })
  const targetHost = hostsRes.data.list[0] // é€‰æ‹©ç¬¬ä¸€å°ä¸»æœº

  // 3. å‡†å¤‡éƒ¨ç½²å‚æ•°
  const deployParams = {
    serviceId: 'mysql',
    version: 'mysql-5.7',
    hostId: targetHost.id,
    installDir: '/opt/data/mysql',
    envVars: {
      MYSQL_ROOT_PASSWORD: 'MySecurePassword123!',
      MYSQL_DATABASE: 'myapp',
      MYSQL_PORT: '3306'
    },
    autoStart: true
  }

  // 4. åˆ›å»ºéƒ¨ç½²ä»»åŠ¡
  const deployRes = await createDeploy(deployParams)
  const deployId = deployRes.data.deployId

  console.log('éƒ¨ç½²ä»»åŠ¡å·²åˆ›å»ºï¼ŒID:', deployId)

  // 5. è½®è¯¢æŸ¥è¯¢éƒ¨ç½²çŠ¶æ€
  const pollingInterval = setInterval(async () => {
    const statusRes = await getDeployStatus(deployId)
    const status = statusRes.data

    console.log('éƒ¨ç½²çŠ¶æ€:', status.statusText)
    console.log('éƒ¨ç½²æ—¥å¿—:\n', status.deployLog)

    // éƒ¨ç½²å®Œæˆ
    if (status.status === 1) {
      console.log('âœ… éƒ¨ç½²æˆåŠŸï¼')
      console.log('æœåŠ¡ä¿¡æ¯:', {
        serviceName: status.serviceName,
        version: status.version,
        hostIp: status.hostIp,
        installDir: status.installDir
      })
      clearInterval(pollingInterval)
    }

    // éƒ¨ç½²å¤±è´¥
    if (status.status === 3) {
      console.error('âŒ éƒ¨ç½²å¤±è´¥ï¼')
      console.error('é”™è¯¯æ—¥å¿—:\n', status.deployLog)
      clearInterval(pollingInterval)
    }
  }, 3000) // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡
}

// è°ƒç”¨ç¤ºä¾‹
deployMySQLExample()
```

---

## æ€»ç»“

### å‰ç«¯å®ç°è¦ç‚¹ï¼š

1. **æœåŠ¡åˆ—è¡¨å±•ç¤º**ï¼šåˆ†ç±»ç­›é€‰ã€å¡ç‰‡å¸ƒå±€ã€ç‰ˆæœ¬æ ‡ç­¾
2. **éƒ¨ç½²é…ç½®è¡¨å•**ï¼šç‰ˆæœ¬é€‰æ‹©ã€ä¸»æœºé€‰æ‹©ã€ç¯å¢ƒå˜é‡é…ç½®
3. **å®æ—¶è¿›åº¦å±•ç¤º**ï¼šçŠ¶æ€å›¾æ ‡ã€æ—¥å¿—å®æ—¶æ»šåŠ¨ã€è½®è¯¢æ›´æ–°
4. **éƒ¨ç½²ç®¡ç†**ï¼šå†å²è®°å½•ã€çŠ¶æ€ç­›é€‰ã€æ—¥å¿—æŸ¥çœ‹ã€æœåŠ¡å¸è½½

### å…³é”®æŠ€æœ¯ç‚¹ï¼š

- âœ… API è¯·æ±‚å°è£…
- âœ… è½®è¯¢çŠ¶æ€æ›´æ–°ï¼ˆ3ç§’é—´éš”ï¼‰
- âœ… è¡¨å•éªŒè¯å’Œæ•°æ®ç»‘å®š
- âœ… å®æ—¶æ—¥å¿—å±•ç¤º
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- âœ… ç»„ä»¶åŒ–è®¾è®¡

å®Œæ•´çš„å‰ç«¯å¯¹æ¥æ–‡æ¡£å·²æä¾›ï¼ŒåŒ…å« Vue3 å’Œ React ä¸¤ç§å®ç°æ–¹å¼ï¼
